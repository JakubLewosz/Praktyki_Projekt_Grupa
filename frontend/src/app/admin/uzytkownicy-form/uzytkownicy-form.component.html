<div class="form-container">
  <h2>{{ userDoEdycji ? 'Edytuj Użytkownika' : 'Dodaj Nowego Użytkownika' }}</h2>
  
  <!-- Prosty loader na czas operacji -->
  @if (isLoading()) {
    <div class="loader">Trwa ładowanie...</div>
  }

  <form [formGroup]="form" (ngSubmit)="zapisz()">
    
    <div class="form-group">
      <label>Nazwa Użytkownika (Username) *</label>
      <input type="text" formControlName="username" class="form-input">
    </div>

    <div class="form-group">
      <label>Email *</label>
      <input type="email" formControlName="email" class="form-input">
    </div>

    <div class="form-group">
      <label>Rola *</label>
      <select formControlName="rola" class="form-input">
        <option>Admin</option>
        <option>Pracownik UKNF</option>
        <option>Podmiot</option>
      </select>
    </div>

    <div class="form-group">
      <label>Hasło {{ userDoEdycji ? '(pozostaw puste, by nie zmieniać)' : '*' }}</label>
      <input type="password" formControlName="password" autocomplete="new-password" class="form-input">
      
      @if (form.get('password')?.invalid && (form.get('password')?.touched || form.get('password')?.dirty)) {
        <div class="error-message">
          @if (form.get('password')?.hasError('required')) {
            Hasło jest wymagane.
          }
          @if (form.get('password')?.hasError('minlength')) {
            Hasło musi mieć co najmniej 6 znaków.
          }
        </div>
      }
      </div>

    <!--
      ===================================================================
      NOWA SEKCJA: PRZYPISANIE DO GRUP (dla Pracownika UKNF)
      ===================================================================
    -->
    @if (form.get('rola')?.value === 'Pracownik UKNF') {
      <div class="form-group dynamic-field" formArrayName="grupy">
        <label>Wybierz Grupy (dla Pracownika UKNF)</label>
        
        @if (listaWszystkichGrup().length === 0 && !isLoading()) {
           <div class="error-message">
             Brak grup do wyboru. Dodaj je w zakładce "Grupy".
           </div>
        } @else {
          <div class="checkbox-list">
            @for (grupa of listaWszystkichGrup(); track grupa.id) {
              <label class="checkbox-label">
                <input 
                  type="checkbox" 
                  [value]="grupa.id" 
                  [checked]="isGrupaChecked(grupa.id)"
                  (change)="onGrupaChange($event)">
                {{ grupa.nazwa }}
              </label>
            }
          </div>
        }
      </div>
    }

    <!--
      ===================================================================
      ISTNIEJĄCA SEKCJA: PRZYPISANIE DO PODMIOTU (dla Podmiotu)
      ===================================================================
    -->
    @if (form.get('rola')?.value === 'Podmiot') {
      <div class="form-group dynamic-field">
        <label>Wybierz Podmiot (Firmę) *</label>
        <select formControlName="podmiotId" class="form-input">
          <option [ngValue]="null" disabled>Wybierz z listy...</option>
          @for (podmiot of listaPodmiotow(); track podmiot.id) {
            <option [ngValue]="podmiot.id">{{ podmiot.nazwa }}</option>
          }
        </select>
        @if (listaPodmiotow().length === 0) {
            <div class="error-message">
             Brak podmiotów do wyboru. Dodaj je w zakładce "Podmioty".
            </div>
        }
      </div>
    }

    <div class="form-actions">
      <button type="button" (click)="anuluj()" class="button button-secondary">Anuluj</button>
      <button type="submit" class="button button-primary" [disabled]="form.invalid || isLoading()">
        {{ isLoading() ? 'Zapisywanie...' : 'Zapisz' }}
      </button>
    </div>

  </form>
</div>